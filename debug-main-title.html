<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Main Title Animation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #111;
            color: white;
            margin: 0;
            padding: 20px;
        }
        .debug-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 350px;
            background: #222;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            font-size: 12px;
            font-family: monospace;
            z-index: 1000;
            max-height: 80vh;
            overflow-y: auto;
        }
        .debug-section {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }
        .debug-title {
            color: #4CAF50;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .status-good { color: #4CAF50; }
        .status-warn { color: #FF9800; }
        .status-error { color: #F44336; }
        .controls {
            background: #333;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        button {
            background: #0066ff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 10px;
            font-size: 16px;
        }
        button:hover { background: #0052cc; }
        button:disabled { background: #444; cursor: not-allowed; }
        #main-app { margin-right: 370px; }
        .console-output {
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="debug-panel">
        <div class="debug-section">
            <div class="debug-title">üîç Animation System Debug</div>
            <div id="debug-info">Loading...</div>
        </div>
        <div class="debug-section">
            <div class="debug-title">üìä Timeline Status</div>
            <div id="timeline-info">Initializing...</div>
        </div>
        <div class="debug-section">
            <div class="debug-title">üé¨ Main Title Status</div>
            <div id="animation-info">Checking...</div>
        </div>
        <div class="debug-section">
            <div class="debug-title">üíæ Console Output</div>
            <div class="console-output" id="console-output"></div>
        </div>
    </div>

    <div id="main-app">
        <h1>üé¨ Main Title Animation Debug Tool</h1>
        
        <div class="controls">
            <button onclick="refreshDebugInfo()">üîÑ Refresh Debug Info</button>
            <button onclick="testAnimationDirectly()">‚ö° Test Animation Directly</button>
            <button onclick="openTemplate()">üìÇ Open Template Editor</button>
        </div>

        <iframe id="template-frame" src="template_001.html" width="100%" height="600" 
                style="border: 2px solid #444; border-radius: 8px; background: white;"></iframe>
    </div>

    <script>
        let debugInterval;
        let consoleMessages = [];
        
        // Capture console messages
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;
        
        function addToConsoleOutput(type, message) {
            const timestamp = new Date().toLocaleTimeString();
            consoleMessages.push(`[${timestamp}] ${type}: ${message}`);
            if (consoleMessages.length > 50) consoleMessages.shift();
            
            const output = document.getElementById('console-output');
            if (output) {
                output.innerHTML = consoleMessages.join('<br>');
                output.scrollTop = output.scrollHeight;
            }
        }
        
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            addToConsoleOutput('LOG', args.join(' '));
        };
        
        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            addToConsoleOutput('ERROR', args.join(' '));
        };
        
        console.warn = function(...args) {
            originalConsoleWarn.apply(console, args);
            addToConsoleOutput('WARN', args.join(' '));
        };

        function getFrameTemplateEditor() {
            try {
                const frame = document.getElementById('template-frame');
                if (frame && frame.contentWindow) {
                    return frame.contentWindow.templateEditor;
                }
            } catch (e) {
                console.error('Cannot access template editor in iframe:', e);
            }
            return null;
        }

        function refreshDebugInfo() {
            const editor = getFrameTemplateEditor();
            
            const debugInfo = document.getElementById('debug-info');
            const timelineInfo = document.getElementById('timeline-info');
            const animationInfo = document.getElementById('animation-info');
            
            if (!editor) {
                debugInfo.innerHTML = '<span class="status-error">‚ùå Template editor not accessible</span>';
                timelineInfo.innerHTML = '<span class="status-error">‚ùå Cannot check timeline</span>';
                animationInfo.innerHTML = '<span class="status-error">‚ùå Cannot check animation</span>';
                return;
            }

            // Debug animation system
            const debugData = {
                hasAnimationSystem: !!editor.animationSystem,
                hasGlobalConfig: !!editor.animationSystem?.global,
                hasElements: !!editor.animationSystem?.elements,
                globalDuration: editor.animationSystem?.global?.duration,
                elementCount: Object.keys(editor.animationSystem?.elements || {}).length,
                hasMainTitle: !!editor.templateObjects?.mainTitle,
                hasBasePositions: !!editor.positionStates?.base,
                mainTitleBaseExists: !!editor.positionStates?.base?.mainTitle
            };

            let debugHtml = '';
            for (const [key, value] of Object.entries(debugData)) {
                const status = value ? 'status-good' : 'status-error';
                const icon = value ? '‚úÖ' : '‚ùå';
                debugHtml += `<div class="${status}">${icon} ${key}: ${value}</div>`;
            }
            debugInfo.innerHTML = debugHtml;

            // Timeline info
            const timeline = editor.timeline;
            if (timeline) {
                const timelineData = {
                    duration: timeline.duration(),
                    progress: (timeline.progress() * 100).toFixed(1) + '%',
                    isActive: timeline.isActive(),
                    paused: timeline.paused(),
                    totalProgress: timeline.totalProgress()
                };
                
                let timelineHtml = '';
                for (const [key, value] of Object.entries(timelineData)) {
                    timelineHtml += `<div class="status-good">üìä ${key}: ${value}</div>`;
                }
                timelineInfo.innerHTML = timelineHtml;
            } else {
                timelineInfo.innerHTML = '<span class="status-error">‚ùå No timeline found</span>';
            }

            // Animation info
            if (editor.templateObjects?.mainTitle) {
                const mainTitle = editor.templateObjects.mainTitle;
                const currentPos = {
                    x: mainTitle.x(),
                    y: mainTitle.y(),
                    opacity: mainTitle.opacity(),
                    visible: mainTitle.visible()
                };
                
                const basePos = editor.positionStates?.base?.mainTitle;
                
                let animHtml = `
                    <div class="status-good">‚úÖ Main Title Element: Found</div>
                    <div class="status-good">üìç Current Position: x=${currentPos.x}, y=${currentPos.y}</div>
                    <div class="status-good">üëÅÔ∏è Opacity: ${currentPos.opacity}</div>
                    <div class="status-good">üì∫ Visible: ${currentPos.visible}</div>
                `;
                
                if (basePos) {
                    animHtml += `
                        <div class="status-good">üéØ Base Position: x=${basePos.x}, y=${basePos.y}</div>
                        <div class="status-good">üìè Distance from base: ${Math.abs(currentPos.y - basePos.y)}px</div>
                    `;
                } else {
                    animHtml += '<div class="status-error">‚ùå No base position found</div>';
                }
                
                animationInfo.innerHTML = animHtml;
            } else {
                animationInfo.innerHTML = '<span class="status-error">‚ùå Main title element not found</span>';
            }
        }

        function testAnimationDirectly() {
            const editor = getFrameTemplateEditor();
            if (!editor) {
                alert('Cannot access template editor');
                return;
            }

            console.log('üß™ Testing main title animation directly...');
            
            try {
                // Get the text animator
                const textAnimator = editor.animationSystem?.getText('mainTitle');
                if (!textAnimator) {
                    console.error('‚ùå Main title text animator not found');
                    return;
                }

                // Reset to initial position
                const basePos = editor.positionStates?.base?.mainTitle;
                if (basePos) {
                    const startY = basePos.y + 100;
                    
                    console.log(`üéØ Resetting to animation start: Y=${startY}, opacity=0`);
                    textAnimator.set({ y: startY, opacity: 0 });
                    
                    // Animate to base position
                    console.log(`üé¨ Starting direct animation: ${startY} ‚Üí ${basePos.y}`);
                    textAnimator.animate({
                        y: basePos.y,
                        opacity: 1
                    }, {
                        duration: 3,
                        ease: 'expo.out',
                        onStart: () => console.log('‚ñ∂Ô∏è Direct animation started!'),
                        onComplete: () => console.log('‚úÖ Direct animation completed!'),
                        onUpdate: function() {
                            const progress = this.progress();
                            if (progress > 0 && Math.floor(progress * 10) % 2 === 0) {
                                console.log(`üé¨ Direct animation: ${Math.round(progress * 100)}%`);
                            }
                        }
                    }, 'direct-test');
                } else {
                    console.error('‚ùå Cannot test - no base position found');
                }
            } catch (error) {
                console.error('‚ùå Direct animation test failed:', error);
            }
        }

        function openTemplate() {
            window.open('template_001.html', '_blank');
        }

        // Auto-refresh debug info
        function startDebugUpdates() {
            debugInterval = setInterval(refreshDebugInfo, 2000);
        }

        function stopDebugUpdates() {
            if (debugInterval) {
                clearInterval(debugInterval);
                debugInterval = null;
            }
        }

        // Initialize
        window.addEventListener('load', () => {
            console.log('üîç Main Title Animation Debug Tool Loaded');
            
            // Wait for iframe to load
            const frame = document.getElementById('template-frame');
            frame.addEventListener('load', () => {
                console.log('üìÇ Template frame loaded, starting debug monitoring...');
                setTimeout(() => {
                    refreshDebugInfo();
                    startDebugUpdates();
                }, 1000);
            });
        });

        // Cleanup on unload
        window.addEventListener('beforeunload', stopDebugUpdates);

        // Global debugging helpers
        window.debugMainTitle = {
            refresh: refreshDebugInfo,
            testDirect: testAnimationDirectly,
            getEditor: getFrameTemplateEditor,
            getConsoleMessages: () => consoleMessages,
            clearConsole: () => {
                consoleMessages = [];
                document.getElementById('console-output').innerHTML = '';
            }
        };
    </script>
</body>
</html>